#!/bin/sh

# Pre-commit hook to enforce coding standards
# To enable: cp .githooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

echo "üîç Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track if any checks fail
FAILED=0

# Function to print colored messages
print_error() {
    echo "${RED}‚úó $1${NC}"
}

print_success() {
    echo "${GREEN}‚úì $1${NC}"
}

print_warning() {
    echo "${YELLOW}‚ö† $1${NC}"
}

# Check if we're in the root directory
if [ ! -f "CODING_STANDARDS.md" ]; then
    print_error "Please run this from the project root directory"
    exit 1
fi

# Backend checks
if [ -d "backend" ]; then
    echo "\nüì¶ Backend checks..."

    # Check for Laravel Pint
    if [ -f "backend/vendor/bin/pint" ]; then
        echo "Running Laravel Pint..."
        cd backend
        ./vendor/bin/pint --test
        if [ $? -ne 0 ]; then
            print_error "Code formatting issues found. Run './vendor/bin/pint' to fix."
            FAILED=1
        else
            print_success "Code formatting passed"
        fi
        cd ..
    else
        print_warning "Laravel Pint not found. Run 'composer install' in backend/"
    fi

    # Check for dd() or dump()
    echo "Checking for debug statements..."
    if grep -r "dd(" backend/app --include="*.php" | grep -v "//"; then
        print_error "Found dd() statements. Please remove them."
        FAILED=1
    elif grep -r "dump(" backend/app --include="*.php" | grep -v "//"; then
        print_error "Found dump() statements. Please remove them."
        FAILED=1
    else
        print_success "No debug statements found"
    fi

    # Check for inline validation in controllers
    echo "Checking for inline validation..."
    if grep -r "\$request->validate(" backend/app/Http/Controllers --include="*.php"; then
        print_error "Found inline validation. Use Form Request classes instead!"
        print_warning "See: CODING_STANDARDS.md#form-request-classes"
        FAILED=1
    else
        print_success "No inline validation found"
    fi

    # Check if new controllers use Request instead of FormRequest
    echo "Checking controller type hints..."
    CONTROLLERS=$(git diff --cached --name-only --diff-filter=ACM | grep "app/Http/Controllers/.*\.php")
    for file in $CONTROLLERS; do
        if grep -q "function .*(Request \$request)" "$file"; then
            if ! grep -q "function index(Request \$request)\|function show(Request \$request)" "$file"; then
                print_error "Controller $file uses Request instead of Form Request class"
                print_warning "Use specific Form Request classes for validation"
                FAILED=1
            fi
        fi
    done

    # Run PHPUnit tests
    if [ -f "backend/vendor/bin/phpunit" ]; then
        echo "Running PHPUnit tests..."
        cd backend
        php artisan test --parallel
        if [ $? -ne 0 ]; then
            print_error "Tests failed. Please fix failing tests before committing."
            FAILED=1
        else
            print_success "All tests passed"
        fi
        cd ..
    else
        print_warning "PHPUnit not found. Skipping tests."
    fi
fi

# Frontend checks
if [ -d "frontend" ]; then
    echo "\nüé® Frontend checks..."

    # Check for console.log
    echo "Checking for console statements..."
    if grep -r "console\.log\|console\.error\|console\.warn" frontend/src --include="*.js" --include="*.vue" | grep -v "//"; then
        print_error "Found console statements. Please remove them."
        FAILED=1
    else
        print_success "No console statements found"
    fi

    # Check for hardcoded API URLs
    echo "Checking for hardcoded URLs..."
    if grep -r "http://localhost:8000\|http://127.0.0.1:8000" frontend/src --include="*.js" --include="*.vue" | grep -v "VITE_API_BASE_URL"; then
        print_error "Found hardcoded API URLs. Use environment variables instead."
        FAILED=1
    else
        print_success "No hardcoded URLs found"
    fi

    # Run ESLint
    if [ -f "frontend/node_modules/.bin/eslint" ]; then
        echo "Running ESLint..."
        cd frontend
        npm run lint
        if [ $? -ne 0 ]; then
            print_error "Linting errors found. Run 'npm run lint:fix' to auto-fix."
            FAILED=1
        else
            print_success "Linting passed"
        fi
        cd ..
    else
        print_warning "ESLint not found. Run 'npm install' in frontend/"
    fi

    # Run frontend tests
    if [ -f "frontend/package.json" ] && grep -q "\"test\":" frontend/package.json; then
        echo "Running frontend tests..."
        cd frontend
        npm run test -- --run
        if [ $? -ne 0 ]; then
            print_error "Frontend tests failed. Please fix failing tests."
            FAILED=1
        else
            print_success "All frontend tests passed"
        fi
        cd ..
    fi
fi

# Check commit message format
echo "\nüìù Checking commit message..."
COMMIT_MSG_FILE="$1"
if [ -f "$COMMIT_MSG_FILE" ]; then
    COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")
    if ! echo "$COMMIT_MSG" | grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert):"; then
        print_warning "Commit message should follow conventional format:"
        print_warning "feat: Add new feature"
        print_warning "fix: Fix bug"
        print_warning "docs: Update documentation"
        print_warning "refactor: Refactor code"
        print_warning "test: Add tests"
        print_warning "chore: Update dependencies"
        print_warning ""
        print_warning "See: CONTRIBUTING.md#commit-messages"
    else
        print_success "Commit message format looks good"
    fi
fi

# Final result
echo "\n"
if [ $FAILED -eq 1 ]; then
    print_error "Pre-commit checks FAILED! Please fix the issues above."
    echo ""
    echo "To skip these checks (NOT RECOMMENDED):"
    echo "git commit --no-verify"
    echo ""
    exit 1
else
    print_success "All pre-commit checks PASSED! ‚ú®"
    echo ""
    exit 0
fi
